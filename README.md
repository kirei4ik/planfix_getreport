PowerShell-скрипт для выгрузки отчетов из Planfix (CRM) в Excel с корректной поддержкой русской кодировки и обходом rate limit API.

## Что делает

- Выгружает готовые отчеты из Planfix через REST API
- Сохраняет в Excel (.xlsx) с правильной кодировкой UTF-8 (русские буквы не кракозябрятся)
- Работает без прав администратора (PowerShell 5.1+)
- Два режима работы:
  - **Создание** — новый файл с датой (`report_YYYYMMDD_HHMMSS.xlsx`)
  - **Обновление** — перезаписывает существующий файл (очищает указанный лист и пишет свежие данные)
- Обходит ограничение API "1 отчет в 10 минут" — при rate limit запрашивает SaveID предыдущего отчета для мгновенного скачивания

## Требования

- Windows (PowerShell 5.1 или 7.x)
- Excel (для сохранения в .xlsx)
- Токен API Planfix (Bearer)
- ID отчета (из URL в Planfix)

## Настройка

Открой скрипт и заполни блок **SETTINGS** в начале:

```powershell
$Token      = "Bearer YOUR_TOKEN_HERE"
$Account    = "your_subdomain"    # поддомен (company.planfix.ru)
$ReportId   = "12345"             # ID отчета из URL

# Режим работы
$UpdateExisting = $false          # $true = обновить существующий файл
$ExistingFileName = "data.xlsx"   # имя файла для обновления
$SheetName = "Лист1"              # имя листа для обновления
```

## Запуск

Через `run.bat` (двойной клик):
```batch
@echo off
powershell -ExecutionPolicy Bypass -File "planfix_report.ps1"
pause
```

Или напрямую из PowerShell:
```powershell
.\planfix_report.ps1
```

## Как это работает

1. **Генерация** — POST-запрос на создание отчета, получение RequestID
2. **Ожидание** — polling статуса каждые 2 секунды до готовности (получение SaveID)
3. **Скачивание** — загрузка чанками через WebClient с явным UTF-8
4. **Сохранение** — запись в Excel через COM-объект (сохраняет форматирование, автоширину колонок)

## Если упираешься в rate limit

При ошибке `9004` скрипт попросит ввести SaveID (число из прошлого успешного запуска) и сразу скачает готовый отчет, не дожидаясь 10 минут.

## Troubleshooting

**"No data downloaded"** — SaveID устарел (хранится ~24 часа). Подожди 10 минут и запусти скрипт заново для генерации свежего отчета.

**Кракозябры в Excel** — скрипт использует `System.Net.WebClient` с `$wc.Encoding = UTF8`, что гарантирует корректную кодировку русского текста в PowerShell 5.1.

## Лицензия

MIT — используй как хочешь.
